<chat-example>
  <div class="panel">
    <div class="panel-header">
      <div class="panel-title h6">Chat</div>
    </div>
    <div class="panel-body chat" ref="container">
      <div each={ m in messages} class={tile: true, me: m.from === user}>
        <div class="tile-icon">
          <figure class="avatar" data-initial={m.from.substr(0,2)}></figure>
        </div>
        <div class="tile-content">
          <p class="tile-title text-bold">{m.from}</p>
          <p class="tile-subtitle">
            {m.message}
          </p>
        </div>
      </div>
      <div class="tile" if={statuses.length} style="position:sticky;">
        <span each={s in statuses}>{s.nickname}, </span> &nbsp; ... are typing
      </div>
      <div class="enter" if={ !user }>
      <div class="input-group">
        <input class="form-input" type="text" placeholder="Nickname.." ref="username">
        <button class="btn btn-primary input-group-btn" onclick={enter}>Start chat</button>
      </div>
    </div>
    </div>
    <div class="panel-footer" if={ user }>
      <div class="input-group">
        <input class="form-input" type="text" placeholder="Hello" ref="message" onkeyup={input}>
        <button class="btn btn-primary input-group-btn" onclick={send}>Send</button>
      </div>
    </div>
  </div>
  <script>
    import client from 'lib/client';
    this.messages = [];
    this.user = this.opts.req.session ? this.opts.req.session.nickname : '';
    this.statuses = [];

    this.on('mount', async () => {

      this.await('get messages')
      this.messages = await client.service('playground/messages').find();
      this.done('get messages')

      if (this.isClient()) {
        this.scroll();
        client.ws.on('playground/messages created', async (data)=> {
          this.messages.push(data);
          this.statuses = this.statuses.filter((u) => u.nickname !== data.from);
          this.update();
          this.scroll();
        })
        client.ws.on('playground/messages patched', async (data)=> {
          this.statuses = this.statuses.filter((u) => u.nickname !== data.nickname);
          if (data.status === 'typing') {
            this.statuses.push(data)
          }
          this.update();
          this.scroll();
        })
      }

    });


    this.enter = async (ev) => {
      const username = this.refs.username.value.trim();
      if (username) {
        await client.io.service('playground/messages').get(username);
        this.user = username;
        this.update();
        this.scroll();
      }
    };

    this.send = async (ev) => {
      const message = this.refs.message.value.trim();
      if (message) {
        await client.io.service('playground/messages').create({
          message,
        });
        this.refs.message.value = '';
        this.scroll();
      }
    };

    this.inputTimeout = null;
    this.input = (ev) => {
      if (ev.code === 'Enter') {
        return this.send(ev);
      }
      else
      {
        client.io.service('playground/messages').patch('typing', {});
        clearTimeout(this.inputTimeout);
        this.inputTimeout = setTimeout(()=>{
          client.io.service('playground/messages').patch('idle', {});
        },1000);
      }
    }
    
    this.scroll = function () {
      this.refs.container.scrollTop = this.refs.container.scrollHeight - this.refs.container.clientHeight;
    }

  </script>
  <style>
    :scope .chat {
      min-height: 450px;
      max-height: 450px;
      overflow-y: scroll;
      flex-wrap: wrap;
      box-shadow: 0px 0px 4px #ccc inset;
      padding: 24px;
    }
    :scope .tile-title {
      margin: 0px;
    }
    :scope .enter {
      justify-content: center;
      margin: 24px;
    }
    :scope .tile {
      padding: 6px;
      border-radius: 6px;
      margin: 6px;
      width: 85%;
      background: #eee;
    }
    :scope .me {
      width: 85%;
      margin-right: 0%;
      margin-left: 15%;
      background: #fef;

    }
  </style>
</chat-example>